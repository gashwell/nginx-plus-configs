# AI Gateway - Main Configuration
# Nginx Plus required

# Key-value stores
keyval_zone zone=api_keys:10m state=/var/lib/nginx/state/api_keys.json;
keyval_zone zone=model_routing:10m state=/var/lib/nginx/state/routing.json;

keyval $http_authorization $is_valid_key zone=api_keys;
keyval $http_authorization $preferred_model zone=model_routing;

# Rate limiting
limit_req_zone $http_authorization zone=ai_requests:10m rate=100r/m;

# NJS for AI routing
js_path "/etc/nginx/njs/";
js_import ai from ai-gateway.js;

# Upstreams
upstream openai {
    zone openai 64k;
    server api.openai.com:443 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream anthropic {
    zone anthropic 64k;
    server api.anthropic.com:443 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream ollama {
    zone ollama 64k;
    server host.docker.internal:11434 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Main server
server {
    listen 443 ssl http2;
    server_name gateway.local;

    ssl_certificate /etc/nginx/ssl/cert.crt;
    ssl_certificate_key /etc/nginx/ssl/cert.key;

    # Authentication
    if ($is_valid_key != "1") {
        return 401 '{"error": "Unauthorized"}';
    }

    # AI endpoint
    location /v1/chat/completions {
        limit_req zone=ai_requests burst=20;
        js_content ai.routeRequest;
    }

    # Health check
    location /health {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
}

# Nginx Plus API
server {
    listen 8080;
    location /api {
        api write=on;
        allow 127.0.0.1;
        allow 172.16.0.0/12;
        deny all;
    }
    
    location = /dashboard.html {
        root /usr/share/nginx/html;
    }
}
